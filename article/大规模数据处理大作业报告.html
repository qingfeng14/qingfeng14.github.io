<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="NulX213KadbLZpcPLeskKULRWdztIKtoHsRG8-LgfWE" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />
<script src="https://cdn.bootcss.com/js-sha1/0.4.1/sha1.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.js"></script>  

<script type="text/javascript"> 
loopy() 
function loopy() { 
    if(''){
        while(true) {
            var pass = prompt("输入正确密码才能查看!");
            if(pass) {
                // 点击的确定
                var ss = sha1(pass)
                // alert(ss);
                if(ss == '') {
                    alert("Welcome! Contact me at zhangshenghao1995@163.com");
                    break;
                }
                else {
                    alert("密码错误！");
                }
            }
            else if(pass == "") {
                // 用户没有输入
            }
            else {
                // 点击取消
                // history.go(-1)

            }
        }
    }
} 
</script> 


  <meta name="keywords" content="青枫，博客，Coding" />





  <link rel="alternate" href="/atom.xml" title="青枫别苑" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/uploads/favicon.png?v=5.1.0" />






<meta name="description" content="项目的目标，完成的功能，实用的意义 现代城市中人们的生活与交通息息相关，一个城市的交通情况总是让人津津乐道，而各种交通工具中，出租车更是每个城市的一面招牌。了解出租车的供求情况，可以提高城市出租车系统的效率。">
<meta property="og:type" content="article">
<meta property="og:title" content="司机之友---出租车行车记录分析报告">
<meta property="og:url" content="https://2young.2simple.top/article/大规模数据处理大作业报告.html">
<meta property="og:site_name" content="青枫别苑">
<meta property="og:description" content="项目的目标，完成的功能，实用的意义 现代城市中人们的生活与交通息息相关，一个城市的交通情况总是让人津津乐道，而各种交通工具中，出租车更是每个城市的一面招牌。了解出租车的供求情况，可以提高城市出租车系统的效率。">
<meta property="og:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/1y1S2r0r343N1r2A2V1e/Image%202017-07-29%20at%208.54.55%20下午.png">
<meta property="og:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/27230S1o2T2f1x3X1Z0O/Image%202017-07-29%20at%208.56.41%20下午.png">
<meta property="og:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/2I1P0S3h1Z1V0J072k3U/Image%202017-07-29%20at%206.36.10%20下午.png">
<meta property="og:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/1d2N1P1C1s0W3W1g0v3j/Image%202017-07-29%20at%206.40.06%20下午.png">
<meta property="og:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/2A3N2D1s2M2P2U0R112h/Image%202017-07-29%20at%207.08.29%20下午.png">
<meta property="og:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/3S1x2Z2L1X3D3O07363p/Image%202017-07-29%20at%209.23.04%20下午.png">
<meta property="og:updated_time" content="2018-01-14T13:01:09.831Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="司机之友---出租车行车记录分析报告">
<meta name="twitter:description" content="项目的目标，完成的功能，实用的意义 现代城市中人们的生活与交通息息相关，一个城市的交通情况总是让人津津乐道，而各种交通工具中，出租车更是每个城市的一面招牌。了解出租车的供求情况，可以提高城市出租车系统的效率。">
<meta name="twitter:image" content="https://d26dzxoao6i3hh.cloudfront.net/items/1y1S2r0r343N1r2A2V1e/Image%202017-07-29%20at%208.54.55%20下午.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'OP8LUUS2MV',
      apiKey: '7aae391e117d5b22f8d4e63407fc967f',
      indexName: 'indexName',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://2young.2simple.top/article/大规模数据处理大作业报告.html"/>





  <title> 司机之友---出租车行车记录分析报告 | 青枫别苑 </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
   
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-100831019-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c804d99384f9668e17adfe738b5e74f3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">青枫别苑</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">张盛豪的个人博客<br/>Coding  && Reading</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://2young.2simple.top/article/大规模数据处理大作业报告.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="青枫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青枫别苑">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                司机之友---出租车行车记录分析报告
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-29T00:00:00+08:00">
                2017-07-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/article/大规模数据处理大作业报告.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/article/大规模数据处理大作业报告.html" class="leancloud_visitors" data-flag-title="司机之友---出租车行车记录分析报告">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  4,082
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  14
                </span>
              
            </div>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="项目的目标完成的功能实用的意义">项目的目标，完成的功能，实用的意义</h1>
<p>现代城市中人们的生活与交通息息相关，一个城市的交通情况总是让人津津乐道，而各种交通工具中，出租车更是每个城市的一面招牌。了解出租车的供求情况，可以提高城市出租车系统的效率。 <a id="more"></a></p>
<p>通过分析出租车的一年的行车数据，可以获知城市的出租车需求模型，进而可以为乘客乘车以及司机载客通过优化措施，了解乘客需求的时空分布，可以为出租车司机合理安排自己的行车路线提供宝贵的意见，以降低出租车的空载时间。我们的项目是针对芝加哥2015年、2016年的出租车交易数据集进行的一系列分析，主要有两个方面的内容，一是对城市的出租车需求、分布以及流动情况进行分析、预测和模拟；二是针对出租车司机小费收入实现的机器学习算法。</p>
<h1 id="数据集">数据集</h1>
<ol style="list-style-type: decimal">
<li>芝加哥2015~2016年出租车行车记录数据
<ul>
<li>来源：https://data.cityofchicago.org/Transportation/Taxi-Trips-Dashboard/spcw-brbq</li>
<li>属性：<code>Trip ID,Taxi ID,Trip Start Timestamp,Trip End Timestamp,Trip Seconds,Trip Miles,Pickup Census Tract,Dropoff Census Tract,Pickup Community Area,Dropoff Community Area,Fare,Tips,Tolls,Extras,Trip Total,Payment Type,Company,Pickup Centroid Latitude,Pickup Centroid Longitude,Pickup Centroid Location,Dropoff Centroid Latitude,Dropoff Centroid Longitude,Dropoff Centroid  Location</code></li>
<li>大小： 2015年数据(27,400,744条，11G),2016年数据(19,878,276条，8G)</li>
</ul></li>
<li>芝加哥2015~2016年每小时天气数据
<ul>
<li>数据来源：美国国家海洋和大气管理局 https://www.ncdc.noaa.gov/</li>
<li>主要属性：<code>DATE,REPORTTPYE, HOURLYSKYCONDITIONS, HOURLYVISIBILITY, HOURLYPRSENTWEATHERTYPE, HOURLYDRYBULBTEMPF, HOURLYDRYBULBTEMPC, HOURLYWETBULBTEMPF, HOURLYWETBULBTEMPC, HOURLYDewPointTempF, HOURLYDewPointTempC, HOURLYRelativeHumidity, HOURLYPrecip</code></li>
<li>数据大小: 12407条记录，3.3M / per_year</li>
</ul></li>
</ol>
<h1 id="项目的架构设计">项目的架构设计</h1>
<p>使用的数据集是单个大文件，每行一条记录。通过对数据以50M为限按行进行切割，将数据分成若干不超过50M的文件后存储在hdfs系统中，以方便交给多个Map任务进行处理。</p>
<p>hdfs文件系统包装了对分布式集群的存储、运算资源的管理。分割数据后，通过hadoop的MapReduce即可方便地进行之后的统计与预测工作。但hadoop的设计也要求，数据相互依赖时，需要分成多个任务进行处理。</p>
<h1 id="项目的难度困难之处在什么地方">项目的难度，困难之处在什么地方</h1>
<ul>
<li>数据清洗：记录的乘车数据中有部分数据超出了正常范围（比如：行车时间为0，费用超高,部分数据上千，等等）这些异常数据需要预先进行抽样分析，设定合适的阈值将其删除</li>
<li>乘客的小费行为分析：行车记录中包含多项特征，其中部分特征影响着乘客的小费行为，根据统计结果来看，不同时刻，WeekDay，不同上车地点，不同天气情况下用户的小费行为会有对应的变化，但是相互间波动并不是特别大，这就造成了对用户小费数额以及比例的预测准确度较低，而小费数额的分类划分也有着对应的影响。</li>
<li>统计中的一个难点在于对缺失数据点的处理。我们以周为周期进行统计，但对给定时间段，并非每以周的给定时间段都有出租车的行车记录。这一数据特征本身很可能是合理的，但无法直接反映在Reduce任务中。对此的一个简单处理，是在求平均和方差时，假定获得了至少52周的数据，即对数据长度取下限。若所有周在该时间段都没有数据，则在预测时给出默认值。</li>
<li>在出租车流动模拟这部分工作中的遇到的一个困难是，为了实时生成当前时段的乘客需求、出租车数量、交通拥挤情况等，我们的算法需要读入建模时生成的文件，这些文件有30MB左右，一开始我们使用Distributed Cache来加载这些文件，对代码进行很多修改尝试都没有成功，后来我们改用FsDataInputStream读取。另外，我们的修正算法中设计的输入输出格式较多样，处理时容易出错导致写出了不少bug调了很久。</li>
</ul>
<h1 id="具体实现">具体实现</h1>
<h2 id="模型学习">模型学习</h2>
<p>实现中，以周为周期，以15分钟为粒度，统计每个时间段内的数据。对于行车时间，特征除了星期、一日内的时间段序号外，还包括起止街区；对于出租车数量，特征有星期、一日内的时间段序号和对应街区。对每个时间段的的街区或街区对，求得数据的均值和方差并输出。输出的参数作为预测的模型，生成预测结果</p>
<h2 id="出租车流动模拟">出租车流动模拟：</h2>
<p>我们对2015年芝加哥出租车数据集进行了一系列的统计分析工作，主要包括对乘客需求、乘车时间、出租车流动的统计与分析。在这个统计结果上，我们进行了数学建模用来预测每周中每时段（15分钟粒度）每街区的乘客需求、空闲出租车数量和交通拥挤情况。在上述预测数据基础上，我们提出一个用以修正数据的算法，模拟出芝加哥市内的出租车流动情况，并使用2016年的数据进行对比。</p>
<h3 id="模型预测">模型预测：</h3>
<p>我们的统计工作是基于周来进行的，及假设不同周的同一天的出租车交易情况是同分布的。我们主要需要完成的是对三个变量的统计：</p>
<ul>
<li>乘客需求：在每一时段，需要可以预测街区A到街区B的乘车需求数量。</li>
<li>空闲出租车数量：在每一时段，需要可以预测街区A的空闲出租车数量</li>
<li>交通拥挤情况的统计：在每一时段，需要可以预测街区A到街区B的出租车移动时间</li>
</ul>
<p>我们认为这三个随机变量是满足高斯分布的，从统计结果可以得出它们的期望以及方差的信息，我们使用这些信息就可以生成每一时段的出租车情况。</p>
<h3 id="修正算法">修正算法</h3>
<p>由于出租车数量的预测完全依赖于统计的出租车交易，然而必然会有空闲的出租车到处乱跑，这些出租车的位置信息是不能从数据集中反映出来的，我们需要对上述的预测模型作出修正。（时间粒度为15分钟）</p>
<p>针对每一个街区：</p>
<ul>
<li>如果某时段的乘客需求＞空闲出租车数量，随机选择等于出租车数量的乘客乘车。剩下的乘客会等待到下一时段乘车，并对该乘客要去的街区的空闲出租车数量进行修正，在该乘客预计到达的时间点所在时段（如果上车了）该乘客要去的街区的空闲出租车数量“-1”。</li>
<li>如果某时段的乘客需求&lt;=空闲出租车数量，所有乘客乘车完成交易，并对本街区的下一时段的出租车数量进行修正，对其增加本次多出的出租车数量，即相当于这些空闲出租车没有离开本街区。</li>
</ul>
<p>一点假设：</p>
<p>由于数据集中没有出租车行车路线的信息，只有起始点经纬度，我们假设这些车按直线匀速行驶。</p>
<h3 id="分布式实现模拟过程">分布式实现模拟过程</h3>
<p>我们使用MapReduce实现这部分工作。模拟这个过程的可并行性在于我们对于每个街区的处理时相同且独立的。</p>
<p>每15分钟处理一次乘车请求，即一轮MapReduce。我们的输入输出文件有77个，每一个文件中包含着该街区在上一轮迭代中生成的乘客需求信息、生成的空闲出租车数量信息、逗留的乘客需求信息、出租车数量修正信息、移动的出租车位置时间信息。</p>
<p>在每一轮迭代的Map阶段（针对每一街区），我们在setup中生成新的乘车需求以及空闲出租车数量等，建立数据结构，在map中一条条处理上一轮输出，cleanup中根据上述的修正算法输出出租车乘车信息、对下一轮修正等。</p>
<p>在每一轮迭代的Partition阶段，我们需要将Map的输出根据Key分配给不同的Reducer，即将每个街区的相关输出集中。</p>
<p>在每一轮迭代的Reduce阶段直接输出。</p>
<h2 id="小费模型">小费模型</h2>
<p>出租车流动模拟算法可以让我们了解芝加哥市内交通情况，对于城市建设有很大的参考意义；小费预测对于司机的工作具有指导意义，帮助司机提高收入。</p>
<h3 id="乘客小费行为特征分析">乘客小费行为特征分析</h3>
<ol style="list-style-type: decimal">
<li>天气数据转换：为了更全面的评估乘客的小费行为，加入了天气的因素，数据处理时首先从天气数据中提取每小时的天气状况，天气分类为：<code>Light_Rain, Heavy_Rain,Moderate_Rain,Heavy_Rain,Snow,Cloudy,Clear</code>, 温度以4°C为间距划分。然后将天气数据加入到初始出租车行车记录数据中，方便后期处理。</li>
<li>小费行为特征统计：为了评估不同条件下乘客的小费行为特性，我们对不同特征下用户的小费数额及给小费的乘客数进行了统计，计算其总数以及平均小费数额<code>Day Month Hour PickUp DropOff Payment WeatherType Temp FareClass TipPercent</code>;</li>
<li><p>小费数额及比例分布统计，为了对用户小费数额进行预测，我们统计了乘客小费分布情况</p>
<div class="figure">
<img src="https://d26dzxoao6i3hh.cloudfront.net/items/1y1S2r0r343N1r2A2V1e/Image%202017-07-29%20at%208.54.55%20下午.png" alt="小费数额分布">
<p class="caption">小费数额分布</p>
</div>
<div class="figure">
<img src="https://d26dzxoao6i3hh.cloudfront.net/items/27230S1o2T2f1x3X1Z0O/Image%202017-07-29%20at%208.56.41%20下午.png" alt="\frac{Tip}{Fare} % 分布图">
<p class="caption"><span class="math inline">\(\frac{Tip}{Fare}\)</span> % 分布图</p>
</div></li>
</ol>
<h3 id="乘客小费行为预测">乘客小费行为预测</h3>
<ol style="list-style-type: decimal">
<li><p>选取的特征：从统计结果来看，乘车地点，乘车时刻，温度因素,支付方式等对用户的小费行为会产生较大影响，因此在进行小费预测时采用了上述特征，而为了评估各种特征对其影响，进行了不同特征的组合。</p></li>
<li><p>类别的划分：从小费数额的分布情况以及小费比例的分布情况，我们对用户的小费行为进行了如下分类：</p></li>
</ol>
<table>
<thead>
<tr class="header">
<th>属性</th>
<th>分类数</th>
<th>分类详情</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Tip</td>
<td>5</td>
<td>0; 0~5; 5~15; 15~30; &gt;30</td>
</tr>
<tr class="even">
<td>Tip Percent</td>
<td>5</td>
<td>0； 0~15%; 15%~30%; 30%~50%; &gt; 50%</td>
</tr>
</tbody>
</table>
<ol start="3" style="list-style-type: decimal">
<li><p>实现方式：采用朴素贝叶斯分类器进行训练和预测</p>
<p>假设各条件相互间独立，即<span class="math display">\[P(y|x_1,\cdots,x_n)P(y) \propto \prod_{i=1}^{n}P(x_i|y)\]</span></p>
<p>在训练时训练 <span class="math inline">\(P(y)\)</span> 以及<span class="math inline">\(P(x_i|y)\)</span></p>
<p>测试时输出 <span class="math display">\[\hat y = argmax_yP(y)\prod_{i=1}^{n}P(x_i|y)\]</span></p></li>
</ol>
<ul>
<li><p>训练–先验概率和条件概率的分布式计算：</p>
<p>Map:输入为每一条打车记录，特征的最后一维为类别，为了方便处理，将花费等数值数据进行了等间距离散，最终所有数据均为离散的类别标签，这里统计不同类别下各个属性的个数，同时统计不同类别出现的个数，输出为（attribute+value, count+label count）</p>
<p>Reduce: 输入为Map阶段的输出，统计条件概率<span class="math inline">\(P(x_i|y)\)</span>，计算先验概率<span class="math inline">\(P(y)\)</span>,输出对应的记录</p></li>
<li><p>测试–小费行为的预测：Map: 采用Cache方式将训练得到的先验概率和条件概率读入到TreeMap中，按行读取2016年的测试数据，计算不同类别下的概率，取最高者为其预测类别，输出预测结果及正确与否，Reduce：统计预测的正确性，输出预测错误的记录以及错误类别组合的概率。</p></li>
<li><p>结果: 小费数额预测准确率91.3%， 小费比例预测准确率：87%</p></li>
<li><p>不同特征的组合的准确率(部分)：</p></li>
</ul>
<table>
<thead>
<tr class="header">
<th><strong>属性</strong></th>
<th><strong>准确率</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Month,DayOfWeek,Hour,PickUpArea,PaymentType,WeatherType,Temp</td>
<td>91.3%</td>
</tr>
<tr class="even">
<td>Month,DayOfWeek,Hour,PickUpArea,PaymentType,WeatherType</td>
<td>90.9%</td>
</tr>
<tr class="odd">
<td>Month,DayOfWeek,PickUpArea,PaymentType,WeatherType</td>
<td>88%%</td>
</tr>
</tbody>
</table>
<p>从特征组合的结果来看，上车地点和支付方式以及乘车时刻对用户的小费行为特征影响最大，这与之前的统计结果是一致的。</p>
<h1 id="项目的实现效果">项目的实现效果</h1>
<h2 id="乘客乘车需求模型">乘客乘车需求模型</h2>
<p>2016年2月1日17：00-17：15的乘客数量分布预测结果如下图，图中的颜色分布较为接近。</p>
<div class="figure">
<img src="https://d26dzxoao6i3hh.cloudfront.net/items/2I1P0S3h1Z1V0J072k3U/Image%202017-07-29%20at%206.36.10%20下午.png" alt="乘客数量分布预测结果">
<p class="caption">乘客数量分布预测结果</p>
</div>
<p>对2月1日的各时间段，将坐标分布分成30*30的方格，各方格内乘客数量求相对误差的绝对值，并求平均，呈现如下图，横轴为时间段的序号。相对而言，上午的相对误差较小，这可能是因为凌晨车乘车需求较少，相对稳定。整体而言误差较大，这是因为不少格点乘客数量很少，有1的误差就会导致相对误差很大；另一方面，我们以周为周期刻画乘客分布的模型本身可能并不符合实际情况。</p>
<div class="figure">
<img src="https://d26dzxoao6i3hh.cloudfront.net/items/1d2N1P1C1s0W3W1g0v3j/Image%202017-07-29%20at%206.40.06%20下午.png" alt="预测误差">
<p class="caption">预测误差</p>
</div>
<h2 id="乘客小费行为模型分析">乘客小费行为模型分析</h2>
<p>我们首先分析了不同特征下用户是否给小费的行为特征，如下图所示，分析了每天的不同时刻，Day of Week, 不同的天气，不同的温度环境下用户的平均小费数额，以及给小费的用户占总乘车数的比例。 从统计结果以及预测结果分析，乘客在每天中午1点的以及傍晚6点~9点的乘车需求最低，而中午12点的乘车需求最高，而从小费数额来看，中午1点乘客给的小费数最少，而在夜间9点乘客给的小费数最高，这也与现实中的作息时间相符。而另一方面，周六时乘客的乘车需求以及给小费的倾向性都是最低的。</p>
<div class="figure">
<img src="https://d26dzxoao6i3hh.cloudfront.net/items/2A3N2D1s2M2P2U0R112h/Image%202017-07-29%20at%207.08.29%20下午.png" alt="小费平均数额与时间地点关系">
<p class="caption">小费平均数额与时间地点关系</p>
</div>
<p>从天气角度来看，随着温度的升高，乘客给小费的数额会增加，当温度高于30°C之后乘客给小费的意愿降低。天气晴朗时乘客给的小费数额较其他天气情况下高，下雨时给小费的乘客比例增加，而下雪时给小费的乘客急剧减少，说明天气因素对乘客的小费行为有较大影响。</p>
<div class="figure">
<img src="https://d26dzxoao6i3hh.cloudfront.net/items/3S1x2Z2L1X3D3O07363p/Image%202017-07-29%20at%209.23.04%20下午.png" alt="用户小费行为与天气的关系">
<p class="caption">用户小费行为与天气的关系</p>
</div>
<h1 id="项目分工">项目分工</h1>
<ul>
<li>张盛豪： 小费行为与不同特征的关系分析，基于乘车地点、时间、天气状况等特征进行小费数额预测、小费比例预测</li>
<li>李明杰：出租车行车时间的统计与估计，各街区出租车数量的统计与估计，模拟结果与真实结果的对比</li>
<li>王俊杰：乘客需求统计分析，模拟出租车流动过程算法实现</li>
</ul>
<h1 id="总结">总结</h1>
<p>此次大作业加深了我们对分布式计算的认识，尤其是熟悉了hadoop的特性和使用方法。MapReduce过程本身似乎只是契合WordCount类似程序；hadoop的设计实现限制每个任务的结果都输出到文件中，进一步降低了MapReduce过程的灵活性。由于时间限制，我们没能进一步尝试Spark等分布式系统。</p>
<p>在完成大作业的过程中，我们更加关注分布式计算的实现过程，在讨论明确预期目标后，又花费较多精力解决编码、设计和hadoop限制之间的矛盾。相较而言，模型结果与实际数据的拟合情况并不是我们关注的焦点。即便如此，我们仍然尝试增加了一系列限制以使我们的模型更加符合实际。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>打赏</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/uploads/wechat-pay.png" alt="青枫 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/uploads/ali-pay.jpg" alt="青枫 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      青枫
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://2young.2simple.top/article/大规模数据处理大作业报告.html" title="司机之友---出租车行车记录分析报告">https://2young.2simple.top/article/大规模数据处理大作业报告.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/article/Massive-Data-Process-FinalProject.html" rel="next" title="Massive-Data-Process-FinalProject">
                <i class="fa fa-chevron-left"></i> Massive-Data-Process-FinalProject
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/article/机考准备.html" rel="prev" title="机考准备">
                机考准备 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="青枫" />
          <p class="site-author-name" itemprop="name">青枫</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/qingfeng14" target="_blank" title="GitHub" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/qingfeng.alex" target="_blank" title="Facebook" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/qingfeng14" target="_blank" title="微博" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/alex-zhangch/activities" target="_blank" title="知乎" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-user-o"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://music.163.com/#/user/home?id=95180074" target="_blank" title="网易云" rel="external nofollow">
                  
                    <i class="fa fa-fw fa-music"></i>
                  
                  网易云
                </a>
              </span>
            
          
        </div>

        
        

        
        

        
        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#项目的目标完成的功能实用的意义"><span class="nav-number">1.</span> <span class="nav-text">项目的目标，完成的功能，实用的意义</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据集"><span class="nav-number">2.</span> <span class="nav-text">数据集</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目的架构设计"><span class="nav-number">3.</span> <span class="nav-text">项目的架构设计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目的难度困难之处在什么地方"><span class="nav-number">4.</span> <span class="nav-text">项目的难度，困难之处在什么地方</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#具体实现"><span class="nav-number">5.</span> <span class="nav-text">具体实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模型学习"><span class="nav-number">5.1.</span> <span class="nav-text">模型学习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#出租车流动模拟"><span class="nav-number">5.2.</span> <span class="nav-text">出租车流动模拟：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模型预测"><span class="nav-number">5.2.1.</span> <span class="nav-text">模型预测：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修正算法"><span class="nav-number">5.2.2.</span> <span class="nav-text">修正算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式实现模拟过程"><span class="nav-number">5.2.3.</span> <span class="nav-text">分布式实现模拟过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小费模型"><span class="nav-number">5.3.</span> <span class="nav-text">小费模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#乘客小费行为特征分析"><span class="nav-number">5.3.1.</span> <span class="nav-text">乘客小费行为特征分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#乘客小费行为预测"><span class="nav-number">5.3.2.</span> <span class="nav-text">乘客小费行为预测</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目的实现效果"><span class="nav-number">6.</span> <span class="nav-text">项目的实现效果</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#乘客乘车需求模型"><span class="nav-number">6.1.</span> <span class="nav-text">乘客乘车需求模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#乘客小费行为模型分析"><span class="nav-number">6.2.</span> <span class="nav-text">乘客小费行为模型分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#项目分工"><span class="nav-number">7.</span> <span class="nav-text">项目分工</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">青枫</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> 强力驱动
</div>


<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Pisces
  </a>
</div>

<br/>






<div class="powered-by">
Contact Me @  <a href="https://www.zhihu.com/people/alex-zhangch/activities" target="_blank" title="知乎" rel="external nofollow">知乎</a>
</div>

<div class="powered-by">
<a href="https://github.com/qingfeng14" target="_blank" title="GitHUb" rel="external nofollow">GitHub</a>
</div>

<div class="powered-by">
<a href="http://weibo.com/qingfeng14" target="_blank" title="微博" rel="external nofollow">微博</a>
</div>

<div class="theme-info">
 <a href="mailto:zhangshenghao1995@163.com?subject=用户意见" target="_blank" title="邮箱" rel="external nofollow">邮箱</a>



</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "d5c03ba471cf40c0b5831477b3e52b64",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  







  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("VtTcivvjyRHmU2GlrgFshvUm-gzGzoHsz", "Ls6YjvYF6PU5qtBlLt7DpMnr");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  


  


</body>
</html>
